!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bazar El Romero  Ropa, Hogar, Plantas y m√°s</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Librer√≠a para leer Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- DOMPurify para sanitizar HTML y prevenir XSS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <style>
    :root{--verde:#3a6b4a;--crema:#f5f1e8;--tierra:#8c5e46;--hoja:#5a8a3a;--texto:#2e2e2e}
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
    body{background:var(--crema);color:var(--texto);padding-bottom:4rem}
    header{background:var(--verde);color:#fff;padding:1.5rem;text-align:center}
    header h1{font-size:2rem;margin-bottom:.5rem}
    header p{font-size:1.1rem;opacity:.9}
    #filtros{display:flex;flex-wrap:wrap;justify-content:center;gap:.5rem;padding:1rem}
    .btn-filtro{background:var(--hoja);border:none;padding:.6rem 1rem;border-radius:25px;color:#fff;font-weight:bold;cursor:pointer;transition:.3s}
    .btn-filtro:hover{background:var(--tierra)}
    .activo{background:var(--verde)}
    #productos{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:1.5rem;padding:2rem}
    .tarjeta{background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.15);overflow:hidden;display:flex;flex-direction:column}
    .tarjeta img{width:100%;height:200px;object-fit:cover}
    .info{padding:1rem;display:flex;flex-direction:column;flex-grow:1}
    .info h3{margin-bottom:.5rem;color:var(--verde)}
    .precio{font-size:1.3rem;font-weight:bold;color:var(--tierra);margin-top:auto}
    .disponible{background:#10b981;color:#fff;padding:.2rem .6rem;border-radius:12px;font-size:.8rem;align-self:flex-start}
    .agotado{background:#ef4444}
    #carritoFlotante{position:fixed;bottom:1rem;right:1rem;background:var(--verde);color:#fff;padding:1rem 1.5rem;border-radius:50px;box-shadow:0 4px 12px rgba(0,0,0,.25);cursor:pointer;display:flex;align-items:center;gap:.5rem;font-weight:bold;z-index:998}
    #modalFondo{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:999;display:none;align-items:center;justify-content:center}
    #modal{background:var(--crema);border-radius:12px;width:90%;max-width:500px;padding:1.5rem;max-height:80vh;overflow-y:auto}
    #modal h3{margin-bottom:1rem;color:var(--verde)}
    #listaCarrito{margin-bottom:1rem}
    .itemCarrito{display:flex;justify-content:space-between;align-items:center;padding:.5rem 0;border-bottom:1px solid var(--tierra)}
    .total{font-size:1.4rem;font-weight:bold;color:var(--tierra);margin-top:1rem;text-align:right}
    .botones{display:flex;gap:1rem;margin-top:1.5rem}
    .botones button{flex:1;padding:.75rem;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
    .btn-wsp{background:#f3f7f5;color:#fff}
    .btn-wsp:hover{background:#1ebe5d}
    .btn-wsp{
    background: #25D366 !important; /* Color verde de WhatsApp */
    color: white !important;
    border: none !important;
    padding: .75rem !important;
    border-radius: 8px !important;
    font-weight: bold !important;
    cursor: pointer !important;
    transition: background-color 0.3s ease !important;
}

.btn-wsp:hover{
    background: #128C7E !important; /* Verde m√°s oscuro al pasar el cursor */
}
    footer{text-align:center;padding:1.5rem;background:var(--tierra);color:#fff;margin-top:2rem}
  </style>
</head>
<script>
  // A√±ade sombra al header y al men√∫ cuando el usuario hace scroll
  window.addEventListener("scroll", () => {
    const header = document.getElementById("mainHeader");
    const filtros = document.getElementById("filtros");
    if (window.scrollY > 10) {
      header.style.boxShadow = "0 4px 8px rgba(0,0,0,0.25)";
      filtros.style.boxShadow = "0 4px 8px rgba(0,0,0,0.15)";
    } else {
      header.style.boxShadow = "none";
      filtros.style.boxShadow = "none";
    }
  });
</script>



<body>
<!-- HEADER FIJO -->
<header style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-image: linear-gradient(to bottom, rgba(58, 107, 74, 0.9), rgba(10, 105, 42, 0.9));
  background-size: cover;
  background-position: center;
  height: 160px;
  display: flex;
  align-items: center;
  padding: 0 2rem;
  color: white;
  z-index: 1000;
">
  <img src="logofrank.jpg" alt="Logo Bazar El Romero"
       style="width: 120px; height: auto; border-radius: 4px; margin-right: 1rem;">
  <div>
    <h1 style="margin: 0; font-size: 1.8em;">Bazar El Romero</h1>
    <p style="margin: 0; font-size: 1em; opacity: 0.9;">Ropa, hogar, plantas y m√°s ¬∑ Villa Clara</p>
  </div>
</header>

 <section style="text-align:center;padding:2rem;background:var(--crema)">
    <img src="hola5.png" alt="Bazar El Romero" style="max-width:50%;border-radius:12px;">
    <p style="margin-top:1rem;font-style:italic;color:var(--tierra)">
      ‚ÄúCalidad y cari√±o en cada detalle.‚Äù
    </p>
  </section>


<!-- MEN√ö FIJO DE CATEGOR√çAS -->
<div id="filtros" style="
  position: fixed;
  top: 160px; /* justo debajo del header */
  left: 0;
  width: 100%;
  background: var(--crema);
  border-bottom: 1px solid var(--tierra);
  z-index: 999;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 0.5rem;
  padding: 0.7rem 1rem;
">
  <button class="btn-filtro activo" onclick="filtrar('todos', event)">Todos</button>
  <button class="btn-filtro" onclick="filtrar('Ropa de Mujer', event)">Ropa de Mujer</button>
  <button class="btn-filtro" onclick="filtrar('Ropa de Hombre', event)">Ropa de Hombre</button>
  <button class="btn-filtro" onclick="filtrar('Ropa de Ni√±a', event)">Ropa de Ni√±a</button>
  <button class="btn-filtro" onclick="filtrar('Cer√°mica', event)">Cer√°mica</button>
  <button class="btn-filtro" onclick="filtrar('Mu√±equer√≠a', event)">Mu√±equer√≠a</button>
  <button class="btn-filtro" onclick="filtrar('Pl√°sticos para el Hogar', event)">Pl√°sticos</button>
  <button class="btn-filtro" onclick="filtrar('Plantas Arom√°ticas y Medicinales', event)">Plantas</button>
  <button class="btn-filtro" onclick="filtrar('Plomer√≠a PVC', event)">Plomer√≠a PVC</button>
</div>
<section id="productos"></section>

  <div id="carritoFlotante" onclick="mostrarCarrito()">
    <span id="carritoIcon">üõí</span>
    <span id="carritoCant">0</span>
  </div>

  <div id="modalFondo" onclick="cerrarCarrito(event)">
    <div id="modal" onclick="event.stopPropagation()">
      <h3>Tu pedido</h3>
      <div id="listaCarrito"></div>
      <div class="total" id="totalCarrito">0.00 CUP</div>
      <div class="botones">
        <button class="btn-wsp" onclick="enviarWhatsApp()">Enviar por WhatsApp</button>
        <button class="btn-cancel" onclick="cerrarCarrito()">Cerrar</button>
      </div>
    </div>
  </div>



  <footer>
    &copy; 2025 Bazar El Romero ‚Äì Villa Clara
  </footer>

  <script>
    /* ----------  CONFIG / DATOS INICIALES  ---------- */
    // Auto-detect server URL based on current location
    // Auto-detect server URL - works for both desktop and mobile
    let API_BASE;
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      // Desktop access - use localhost
      API_BASE = 'http://localhost:3000';
    } else {
      // Mobile or network access - use the current host
      API_BASE = `${window.location.protocol}//${window.location.hostname}:3000`;
    }
    
    // Log the detected API base for debugging
    console.log('API Base detected:', API_BASE, '| Host:', window.location.hostname);
    // El cat√°logo se carga desde el backend
    let catalogo = [];
    
    // Funci√≥n para escapar HTML (prevenir XSS)
    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
      };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    // Carga cat√°logo desde el servidor; si falla, intenta usar localStorage como fallback.
    async function loadCatalogFromServer() {
      try {
        const res = await fetch(`${API_BASE}/products`);
        if (!res.ok) throw new Error('No se pudo obtener cat√°logo desde servidor');
        let productos = await res.json();
        // Filtrar productos inactivos (solo mostrar activos en la tienda p√∫blica)
        catalogo = productos.filter(p => p.active !== false);
        console.log('Cat√°logo cargado desde servidor, elementos:', catalogo.length, '(total:', productos.length, ')');
      } catch (e) {
        console.warn('No se pudo conectar al servidor, usando fallback localStorage:', e.message);
        const local = JSON.parse(localStorage.getItem('romeroCatalogo') || 'null');
        if (local && local.length) {
          // Filtrar productos inactivos tambi√©n en el fallback
          catalogo = local.filter(p => p.active !== false);
        }
      }
    }


    /* ----------  CARRITO  ---------- */
    let carrito = [];
    const carritoCant = document.getElementById('carritoCant');
    const carritoIcon = document.getElementById('carritoIcon');

    function addCarrito(id){
      const prod = catalogo.find(p=>p.id===id);
      if(!prod){ alert('Producto no encontrado'); return; }
      if(!prod.disponible){ alert('Producto agotado'); return; }
      const linea = carrito.find(l=>l.id===id);
      if(linea){
        linea.cant++;
      }else{
        carrito.push({...prod, cant:1});
      }
      actualizarCarritoUI();
      mostrarCarrito();
    }

    function actualizarCarritoUI(){
      const total = carrito.reduce((t,l)=>t+l.cant,0);
      carritoCant.textContent = total;
      carritoIcon.textContent = 'üõí';
    }

    function mostrarCarrito(){
      const lista = document.getElementById('listaCarrito');
      const totalEl = document.getElementById('totalCarrito');
      lista.innerHTML = '';
      if(carrito.length === 0){
        const p = document.createElement('p');
        p.style.color = '#666';
        p.textContent = 'No hay productos en el carrito';
        lista.appendChild(p);
        totalEl.textContent = '0.00 CUP';
      } else {
        let suma = 0;
        carrito.forEach(l=>{
        const div = document.createElement('div');
        div.className = 'itemCarrito';
        
        const divInfo = document.createElement('div');
        const strong = document.createElement('strong');
        strong.textContent = l.nombre || '';
        const br = document.createElement('br');
        const small = document.createElement('small');
        small.textContent = `${l.cant} √ó ${Number(l.precio).toFixed(2)} CUP`;
        divInfo.appendChild(strong);
        divInfo.appendChild(br);
        divInfo.appendChild(small);
        
        const divCant = document.createElement('div');
        const btnMenos = document.createElement('button');
        btnMenos.className = 'inline';
        btnMenos.textContent = '‚àí';
        btnMenos.onclick = () => modCant(l.id, -1);
        const span = document.createElement('span');
        span.style.margin = '0 .6rem';
        span.textContent = l.cant;
        const btnMas = document.createElement('button');
        btnMas.className = 'inline';
        btnMas.textContent = '+';
        btnMas.onclick = () => modCant(l.id, 1);
        
        divCant.appendChild(btnMenos);
        divCant.appendChild(span);
        divCant.appendChild(btnMas);
        
        div.appendChild(divInfo);
        div.appendChild(divCant);
        lista.appendChild(div);
          suma += l.cant * l.precio;
        });
        totalEl.textContent = suma.toFixed(2) + ' CUP';
      }
      document.getElementById('modalFondo').style.display='flex';
    }

    function modCant(id, cambio){
      const linea = carrito.find(l=>l.id===id);
      if(!linea) return;
      linea.cant += cambio;
      if(linea.cant <= 0) carrito = carrito.filter(l=>l.id!==id);
      actualizarCarritoUI();
      mostrarCarrito();
    }

    function cerrarCarrito(e){
      if(!e || e.target.id === 'modalFondo') document.getElementById('modalFondo').style.display='none';
    }

    function enviarWhatsApp(){
      if(carrito.length === 0){ alert('Carrito vac√≠o'); return; }
      const tlf = '5353941233'; /* n√∫mero que pediste mantener */
      let texto = 'Hola, quisiera hacer este pedido:%0A%0A';
      let total = 0;
      carrito.forEach(l=>{
        texto += `‚Ä¢ ${l.nombre} (${l.cant}√ó${Number(l.precio).toFixed(2)} CUP)%0A`;
        total += l.cant * l.precio;
      });
      texto += `%0A*Total: ${total.toFixed(2)} CUP*%0A%0A¬øEst√° disponible?`;
      const url = `https://wa.me/${tlf}?text=${encodeURIComponent(decodeURIComponent(texto))}`;
      window.open(url, '_blank');
    }

    /* ----------  RENDER TIENDA  ---------- */
    const cont = document.getElementById('productos');
    function renderizar(lista = catalogo){
      cont.innerHTML = '';
      // Filtrar solo productos activos para mostrar en la tienda
      const productosActivos = lista.filter(p => p.active !== false);
      productosActivos.forEach(p=>{
        const tarjeta = document.createElement('div');
        tarjeta.className = 'tarjeta';
        
        // Crear elementos de forma segura
        const img = document.createElement('img');
        img.src = escapeHtml(p.img || '');
        img.alt = escapeHtml(p.nombre || '');
        
        // Manejar errores de carga de imagen
        img.onerror = function() {
          // Si la imagen falla al cargar, usar placeholder
          this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgZmlsbD0iI2Y1ZjFlOCIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM4YzVlNDYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5TaW4gSW1hZ2VuPC90ZXh0Pjwvc3ZnPg==';
          this.onerror = null; // Evitar loop infinito
        };
        
        const info = document.createElement('div');
        info.className = 'info';
        
        const h3 = document.createElement('h3');
        h3.textContent = p.nombre || '';
        
        const span = document.createElement('span');
        span.className = p.disponible ? 'disponible' : 'agotado';
        span.textContent = p.disponible ? 'Disponible' : 'Agotado';
        
        const precio = document.createElement('div');
        precio.className = 'precio';
        precio.textContent = Number(p.precio).toFixed(2) + ' CUP';
        
        const btn = document.createElement('button');
        btn.textContent = 'Agregar';
        btn.style.cssText = 'margin-top:.5rem;padding:.4rem .8rem;border:none;border-radius:8px;background:var(--hoja);color:#fff;font-weight:bold;cursor:pointer';
        btn.onclick = () => addCarrito(p.id);
        
        info.appendChild(h3);
        info.appendChild(span);
        info.appendChild(precio);
        info.appendChild(btn);
        
        tarjeta.appendChild(img);
        tarjeta.appendChild(info);
        cont.appendChild(tarjeta);
      });
    }

    function filtrar(cat, ev){
      document.querySelectorAll('.btn-filtro').forEach(b=>b.classList.remove('activo'));
      if(ev && ev.target) ev.target.classList.add('activo');
      // Filtrar por categor√≠a y asegurar que solo se muestren productos activos
      const listaFiltrada = cat === 'todos' ? catalogo : catalogo.filter(x=>x.categoria === cat);
      renderizar(listaFiltrada.filter(p => p.active !== false));
    }

    // render inicial: cargar cat√°logo desde servidor (fallback localStorage)
    loadCatalogFromServer().then(() => renderizar());

  </script>
</body>
</html>
